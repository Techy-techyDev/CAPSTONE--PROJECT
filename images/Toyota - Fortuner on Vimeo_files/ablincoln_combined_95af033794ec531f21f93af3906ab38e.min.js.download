(function(e,t){var n={COOKIE_EXP_LIST:"_abexps",OVERRIDE_PREFIX:"ab_",STATE_PAUSED:2,STATE_STOPPED:3,TIME_ONE_YEAR:365,LONG_SCALE:0xfffffffffffff,current_test:null,running_tests:{},debug_mode:false,defaults:{inputs:null,primary_unit:null,namespace:null,experiment:undefined,salt:null,num_segments:null,available_segments:{},segment_allocations:{}}};function i(e,t,i){var r;for(r in n){if(n.hasOwnProperty(r)){this[r]=n[r]}}this.tests=e;this.user=t;this.disabled=i}i.prototype.getTest=function(e){var t,n;if(this.disabled){this.current_test=null;return this}if(typeof this.tests[e]==="undefined"){this._logIfDebug('ABLincoln.getTest: Test "'+e+'" not created in Modworld');this.current_test=null;return this}this.current_test=e;if(typeof this.running_tests[e]!=="undefined"){this._logIfDebug("ABLincoln.getTest: Test already loaded, returning");return this}this._logIfDebug('ABLincoln.getTest: Loading test "'+e+'"');this.running_tests[e]={};t=this.running_tests[e];for(n in this.defaults){if(this.defaults.hasOwnProperty(n)){t[n]=this.defaults[n]}}t.namespace=this.tests[e];t.num_segments=t.namespace.buckets;switch(t.namespace.input){case"vuid":var i=this.user&&this.user.vuid;if(!i){throw new Error(e+" uses VUID input and no VUID was available on the provided user. This is very strange and should never happen. Something weird happened with your ABLincoln client instantiation.")}t.inputs={vuid:i};t.primary_unit="vuid";break;case"cuid":var r=this.user&&this.user.cuid;if(!r){throw new Error(e+"uses CUID input and no CUID was available on the provided user. You are likely including logged out users in a test set up for logged in users only.")}t.inputs={cuid:r};t.primary_unit="cuid";break;case"other":t.inputs=null;t.primary_unit=null;break}return this};i.prototype.setInputs=function(e){if(this.disabled){return this}var t=this.running_tests[this.current_test];if(this.current_test===null){this._logIfDebug("ABLincoln.setInputs: No test set, returning");return this}t.inputs=e;for(var n in t.inputs){if(t.inputs.hasOwnProperty(n)){break}}t.primary_unit=n;this._logIfDebug("ABLincoln.setInputs: Inputs set to "+JSON.stringify(e));this._logIfDebug('ABLincoln.setInputs: Primary Unit set to "'+t.primary_unit+'"');return this};i.prototype.get=function(e,t){if(this.disabled){return t}var n=this.running_tests[this.current_test],i=this._getOverride(e);if(i!==null){this._logIfDebug('ABLincoln.get: Override set for "'+e+'", returning "'+i+'"');return i}if(typeof t==="undefined"){t=null}if(typeof n==="undefined"){this._logIfDebug('ABLincoln.get: No test set, returning default "'+t+'"');return t}if(n.inputs===null){throw"Must set test inputs via setInputs() before loading a parameter."}n.experiment=this._getExperimentForTest(n.namespace);if(typeof n.experiment==="undefined"||n.experiment===null){this._logIfDebug('ABLincoln.get: Not bucketed to an experiment, returning default "'+t+'"');n.experiment=null;return t}this._logIfDebug("ABLincoln.get: Assigned to experiment with id "+n.experiment.id);if(!this._userInSegment()){this._logIfDebug('ABLincoln.get: User not in segment, returning default "'+t+'"');return t}n.salt=n.namespace.name+"."+n.experiment.name;if(n.namespace.input==="vuid"){return this._getParameterByVUID(e,t)}return this._getTreatmentForExperiment(e,t)};i.prototype.setDebug=function(e){this.debug_mode=e;console.log('ABLincoln.setDebug: Debug mode set to "'+e+'"');return this};i.prototype.sendTrackingPixelRequest=function(e){var t=[],n;for(key in e){if(e.hasOwnProperty(key)){t.push(encodeURIComponent(key)+"="+encodeURIComponent(e[key]))}}var i="/ablincoln/tracking_pixel?"+t.join("&");if(typeof navigator.sendBeacon==="function"){navigator.sendBeacon(i);return}n=new Image;n.src=i};i.prototype._getExperimentForTest=function(e){var t=this.running_tests[this.current_test],n,i,r;if(typeof t.experiment!=="undefined"){this._logIfDebug("ABLincoln._getExperimentForTest: Experiment already set, returning");return t.experiment}for(r=0;r<t.num_segments;r++){t.available_segments[r]=r}this._setupExperiments(e.experiments);n=this._randomInteger(0,t.num_segments-1,e.name+".segment",t.inputs[t.primary_unit]);i=t.segment_allocations[n];return e.experiments.filter(function(e){return e.id===i})[0]};i.prototype._setupExperiments=function(e){var t=[],n,i,s,o;for(s=0;s<e.length;s++){if(e[s].state===this.STATE_STOPPED){t.push(e[s])}}t.sort(function(e,t){return r(t.stopped_on)-r(e.stopped_on)});for(s=0;s<e.length;s++){n=r(e[s].published_on);for(o=t.length-1;o>=0;o--){i=r(t[o].stopped_on);if(i<n){this._removeExperiment(t[o]);t.splice(o,1);continue}break}this._addExperiment(e[s])}for(o=t.length-1;o>=0;o--){this._removeExperiment(t[o])}};i.prototype._addExperiment=function(e){var t=this.running_tests[this.current_test],n,i=e.buckets,r=e.name,s,o;s=this._countProps(t.available_segments);if(s<i){return}n=this._sample(t.available_segments,i,t.namespace.name+".sampled_segments",r);for(o in n){if(n.hasOwnProperty(o)){t.segment_allocations[n[o]]=e.id;delete t.available_segments[n[o]]}}this._logIfDebug('ABLincoln._addExperiment: Adding experiment "'+e.name+'"')};i.prototype._removeExperiment=function(e){var t=this.running_tests[this.current_test],n;for(n in t.segment_allocations){if(t.segment_allocations.hasOwnProperty(n)&&t.segment_allocations[n]===e.id){t.available_segments[n]=n;delete t.segment_allocations[n]}}this._logIfDebug('ABLincoln._removeExperiment: Removing experiment "'+e.name+'"')};i.prototype._getParameterByVUID=function(t,n){var i=this.running_tests[this.current_test],r=this._cookie(this.COOKIE_EXP_LIST),s=r?JSON.parse(r):{},o=[],u,a,p,f;var l=function(t){if(e.OnetrustActiveGroups&&e.OnetrustActiveGroups.indexOf(",C0002,")!==-1){this._cookie(this.COOKIE_EXP_LIST,t,this.TIME_ONE_YEAR)}};for(a in this.tests){if(this.tests.hasOwnProperty(a)){for(p in this.tests[a].experiments){if(this.tests[a].experiments.hasOwnProperty(p)){u=this.tests[a].experiments[p];if(u.state===this.STATE_STOPPED){delete s[u.id]}}}}}if(i.experiment.state===this.STATE_PAUSED&&typeof s[i.experiment.id]==="undefined"){r=JSON.stringify(s);l.call(this,r);this._logIfDebug('ABLincoln._getParameterByVUID: Experiment paused and user not yet exposed, returning default "'+n+'"');return n}f=this._getTreatmentForExperiment(t,n);s[i.experiment.id]=f;r=JSON.stringify(s);l.call(this,r);return f};i.prototype._getTreatmentForExperiment=function(e,t){var n=this.running_tests[this.current_test],i=n.experiment.parameters,r=[],s=[],o=n.salt+"."+e,u,a;for(u in i){if(i.hasOwnProperty(u)){a=i[u];if(a.name===e){r.push(u);s.push(a.weight)}}}if(r.length===0){return t}u=this._weightedChoice(r,s,o,n.inputs);this._logIfDebug('ABLincoln._getTreatmentForExperiment: Returning treatment "'+i[u].choice+'" (id '+i[u].id+")");this._log("exposure",i[u]);return i[u].choice};i.prototype._getSegmentValue=function(e){if(this.user.hasOwnProperty(e)){return this.user[e]}return null};i.prototype._userInSegment=function(){var e=this._getFormattedSegmentObj(),t,n;for(t in e.exclude){if(e.exclude.hasOwnProperty(t)){n=e.exclude[t];if(this._indexOf(this._getSegmentValue(t),n)!==-1){return false}}}for(t in e.include){if(e.include.hasOwnProperty(t)){n=e.include[t];if(this._indexOf(this._getSegmentValue(t),n)===-1){return false}}}return true};i.prototype._getFormattedSegmentObj=function(){var e=this.running_tests[this.current_test],t={include:{},exclude:{}},n,i,r,s;for(r in e.experiment.segments){if(e.experiment.segments.hasOwnProperty(r)){n=e.experiment.segments[r];i=n.include===1?"include":"exclude";if(typeof t[i][n.type]==="undefined"){t[i][n.type]=[]}for(s in n.values){if(n.values.hasOwnProperty(s)){t[i][n.type].push(n.values[s])}}}}return t};i.prototype._cookie=function(e,n,i,r,s,o){var u;if(arguments.length>1){if(i){u=new Date;u.setDate(u.getDate()+i)}if(typeof r==="undefined"){r="/"}return t.cookie=e+"="+encodeURIComponent(n)+(typeof u!=="undefined"?"; expires="+u.toGMTString():"")+(r?"; path="+r:"")+(s?"; domain="+s:"")+(o?"; secure":"")}return decodeURIComponent((("; "+t.cookie).split("; "+e+"=")[1]||"").split(";")[0])};i.prototype._getOverride=function(e){var t=this,n=[],i,r;i=location.search.substr(1).split("&");for(r in i){if(i.hasOwnProperty(r)){n=i[r].split("=");if(decodeURIComponent(n[0])===t.OVERRIDE_PREFIX+e){return decodeURIComponent(n[1])}}}return null};i.prototype._indexOf=function(e,t){var n;for(n=0;n<t.length;n++){if(t[n]===e){return n}}return-1};i.prototype._countProps=function(e){var t=0,n;if(typeof e.__count__!=="undefined"){return e.__count__}if(Object.keys){return Object.keys(e).length}for(n in e){if(e.hasOwnProperty(n)){t++}}return t};i.prototype._getUnit=function(e,t){var n=e,i=[],r;if(n instanceof Array){i=n}else if(n instanceof Object){for(r in n){if(n.hasOwnProperty(r)){i.push(n[r])}}}else{i.push(n)}if(typeof t!=="undefined"&&t!==null){i.push(t)}return i};i.prototype._getHash=function(e,t,n){var i=this._getUnit(t,n).map(function(e){return e.toString()}),r=i.join("."),s=CryptoJS.SHA1(e+"."+r).toString().substr(0,13);return parseInt(s,16)};i.prototype._getUniform=function(e,t,n,i,r){var s=this._getHash(n,i,r)/parseFloat(this.LONG_SCALE);return e+s*(t-e)};i.prototype._randomInteger=function(e,t,n,i){return e+this._getHash(n,i)%(t-e+1)};i.prototype._weightedChoice=function(e,t,n,i){var r=t,s=0,o,u;if(e.length===0){return[]}for(u=0;u<r.length;u++){s+=r[u];r[u]=s}o=this._getUniform(0,s,n,i);for(u=0;u<r.length;u++){if(o<=r[u]){return e[u]}}};i.prototype._sample=function(e,t,n,i){var r=[],s,o,u;for(s in e){if(e.hasOwnProperty(s)){r.push(e[s])}}for(s=r.length-1;s>0;s--){o=this._getHash(n,i,s)%(s+1);u=r[s];r[s]=r[o];r[o]=u}return r.slice(0,t)};i.prototype._log=function(e,t){var n=this.running_tests[this.current_test],i={event:e,vuid:this.user?this.user.vuid:"",cuid:this.user?this.user.cuid:null},r,s;if(typeof n!=="undefined"&&typeof n.experiment!=="undefined"){i.experiment_id=n.experiment.id;i.inputs=JSON.stringify(n.inputs);i.salt=n.salt;i.name=n.experiment.name.replace(/ /g,"-");if(typeof n.namespace!=="undefined"){i.namespace_id=n.namespace.id}}if(typeof t!=="undefined"){i.param_id=t.id;i.param_name=t.name;i.param_value=t.choice;this._logIfDebug('ABLincoln._log: logging exposure to treatment "'+t.choice+'" (id '+t.id+")")}this.sendTrackingPixelRequest(i)};function r(e){var t=e.split(/[- :]/);return Date.parse(new Date(t[0],t[1]-1,t[2],t[3],t[4],t[5]))}i.prototype._logIfDebug=function(e){if(this.debug_mode){console.log(e)}};if(e.ablincoln_config&&e.ablincoln_config.tests){e.ABLincoln=new i(e.ablincoln_config.tests,e.ablincoln_config.user,e.ablincoln_config.disabled)}})(window,document);var CryptoJS=CryptoJS||function(e,t){var n={},i=n.lib={},r=function(){},s=i.Base={extend:function(e){r.prototype=this;var t=new r;e&&t.mixIn(e);t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)});t.init.prototype=t;t.$super=this;return t},create:function(){var e=this.extend();e.init.apply(e,arguments);return e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},o=i.WordArray=s.extend({init:function(e,n){e=this.words=e||[];this.sigBytes=n!=t?n:4*e.length},toString:function(e){return(e||a).stringify(this)},concat:function(e){var t=this.words,n=e.words,i=this.sigBytes;e=e.sigBytes;this.clamp();if(i%4)for(var r=0;r<e;r++)t[i+r>>>2]|=(n[r>>>2]>>>24-8*(r%4)&255)<<24-8*((i+r)%4);else if(65535<n.length)for(r=0;r<e;r+=4)t[i+r>>>2]=n[r>>>2];else t.push.apply(t,n);this.sigBytes+=e;return this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-8*(n%4);t.length=e.ceil(n/4)},clone:function(){var e=s.clone.call(this);e.words=this.words.slice(0);return e},random:function(t){for(var n=[],i=0;i<t;i+=4)n.push(4294967296*e.random()|0);return new o.init(n,t)}}),u=n.enc={},a=u.Hex={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],i=0;i<e;i++){var r=t[i>>>2]>>>24-8*(i%4)&255;n.push((r>>>4).toString(16));n.push((r&15).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,n=[],i=0;i<t;i+=2)n[i>>>3]|=parseInt(e.substr(i,2),16)<<24-4*(i%8);return new o.init(n,t/2)}},p=u.Latin1={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],i=0;i<e;i++)n.push(String.fromCharCode(t[i>>>2]>>>24-8*(i%4)&255));return n.join("")},parse:function(e){for(var t=e.length,n=[],i=0;i<t;i++)n[i>>>2]|=(e.charCodeAt(i)&255)<<24-8*(i%4);return new o.init(n,t)}},f=u.Utf8={stringify:function(e){try{return decodeURIComponent(escape(p.stringify(e)))}catch(e){throw Error("Malformed UTF-8 data")}},parse:function(e){return p.parse(unescape(encodeURIComponent(e)))}},l=i.BufferedBlockAlgorithm=s.extend({reset:function(){this._data=new o.init;this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=f.parse(e));this._data.concat(e);this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,i=n.words,r=n.sigBytes,s=this.blockSize,u=r/(4*s),u=t?e.ceil(u):e.max((u|0)-this._minBufferSize,0);t=u*s;r=e.min(4*t,r);if(t){for(var a=0;a<t;a+=s)this._doProcessBlock(i,a);a=i.splice(0,t);n.sigBytes-=r}return new o.init(a,r)},clone:function(){var e=s.clone.call(this);e._data=this._data.clone();return e},_minBufferSize:0});i.Hasher=l.extend({cfg:s.extend(),init:function(e){this.cfg=this.cfg.extend(e);this.reset()},reset:function(){l.reset.call(this);this._doReset()},update:function(e){this._append(e);this._process();return this},finalize:function(e){e&&this._append(e);return this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new h.HMAC.init(e,n).finalize(t)}}});var h=n.algo={};return n}(Math);(function(){var e=CryptoJS,t=e.lib,n=t.WordArray,i=t.Hasher,r=[],t=e.algo.SHA1=i.extend({_doReset:function(){this._hash=new n.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var n=this._hash.words,i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],p=0;80>p;p++){if(16>p)r[p]=e[t+p]|0;else{var f=r[p-3]^r[p-8]^r[p-14]^r[p-16];r[p]=f<<1|f>>>31}f=(i<<5|i>>>27)+a+r[p];f=20>p?f+((s&o|~s&u)+1518500249):40>p?f+((s^o^u)+1859775393):60>p?f+((s&o|s&u|o&u)-1894007588):f+((s^o^u)-899497514);a=u;u=o;o=s<<30|s>>>2;s=i;i=f}n[0]=n[0]+i|0;n[1]=n[1]+s|0;n[2]=n[2]+o|0;n[3]=n[3]+u|0;n[4]=n[4]+a|0},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,i=8*e.sigBytes;t[i>>>5]|=128<<24-i%32;t[(i+64>>>9<<4)+14]=Math.floor(n/4294967296);t[(i+64>>>9<<4)+15]=n;e.sigBytes=4*t.length;this._process();return this._hash},clone:function(){var e=i.clone.call(this);e._hash=this._hash.clone();return e}});e.SHA1=i._createHelper(t);e.HmacSHA1=i._createHmacHelper(t)})();
//# sourceMappingURL= 